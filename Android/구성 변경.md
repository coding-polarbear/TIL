# 구성 변경
**구성(Configuration)**
> 컴포넌트에서 어떤 리소스를 사용할지 결정하는 조건으로, 이 조건 항목은 프레임워크에서 정해져있음

## 리소스 반영
* 구성은 컴포넌트에서 사용하는 리소스를 결정하기 때문에, 구성이 변경되면 컴포넌트에서 사용하는 리소스도 변경됨.
* 만약 설정에서 언어 설정이 변경되면, 안드로이드에서는 액티비티를 재시작시켜서 처음부터 변경된 리소스를 띄우는 방식을 사용함.

## 구성 변경으로 인한 액티비티 재시작
* 구성이 변경되어 액티비티를 재시작하면 하나의 인스턴스를 가지고 새로 초기화해서 재사용하는 것이 아님
* 기존 인스턴스는 `onDestroy()`까지 실행하고 새 인스턴스가 `onCreate()` 부터 실행함.

### 메모리 누수 가능성
* 액티비티가 재시작하며서 메모리 누수 문제가 생길 수 있음
* Activity가 `onDestroy()` 까지 불리었는데도 Activity에 대한 참조가 남아있다면 이 Activity는 GC되지 않고 메모리를 계속 차지함. 
* 화면을 회전할 때 자꾸 `Out Of Memory`가 발생한다면 원인은 메모리 누수 때문

#### Activity 목록 참조
* 더 있는 Activity에 특별한 작업을 ㅎ라기 위해서 Activity인스턴스를 컬렉션에 모아둠
* 최악의 상황으로 `WeakReference`를 사용하더라도 가능하면 피해야 함
* 기능 요구사항이나 레거시 코드 문제로 사용한 적은 있지만 권장되지 않는 방식.
* 액티비티 목록은 시스템이 알아서 관리하는 영역이기도 하고, 액티비티가 종료할 때 컬렉션에서 제거해야 하는데 실수로 빠뜨릴 가능성도 많음

#### Activity의 내부 클래스나 익명 클래스 인스턴스
* Activity의 내부 클래스나 익명 클래스의 인스턴스가 Activity에 대한 참조를 갖고 있다면, 이들 인스턴스를 외부에 리스너로 등록한 경우에 해제도 반드시 되어야 함.
* 해제를 빠뜨리는 것은 메모리 누수의 주된 원인
* 내부 클래스에서는 `SomeActivity.this`를 쓸 수 있는 상황이면 Activity에 대한 참조를 갖고 있는 것이므로, 이때 Activity 참조를 없애기 위해서 단순 내부 클래스는 정적 내부 클래스로 만드는 것이 권장됨
* Activity의 변수나 메소드에 꼭 필요한 접근할 일이 있다면 정적 내부 클래스 생성자에 weakReference로 Activity를 전달하기도 함.  코드가 복잡해지지만 문제가 심각하다면 고려할 수 있는 방법

#### 싱글톤에서 Activity 참조
* 싱글톤에 Context가 전달되어야 하는데 Activity 자신을 전달한 경우
* 싱글톤에 Activity 참조가 남아서 문제를 일으킴.

#### AsyncTask에서 Activity참조
* AsyncTask에서 작업이 오래 걸리는 경우에도 문제를 발생시킴.
* Activity가 시작하면서 작업을 시작하기 위해 `onCreate()` 에서 AsyncTask를 시작한다고 하면, AsyncTask는 Activity에 대한 참조를 가지고 있기 때문에, 화면을 회전하고 `onDestroy()`까지 불러도 AsyncTask가 끝나기 전에는 Activity는 GC의 대상이 되지 않음.
* 게다가 `onCreate()`에서  `AsyncTask`를 실행하면 회전할 때 마다 AsyncTask가 매번 실행됨
* Activity 자체나 AsyncTask 작업이 메모리를 많이 차지하고, AsyncTask가 시간이 오래 걸린다면 `OutOfMemoryError`가 발생할 가능성이 높아짐.

### 프레임워크 소스 확인
* 구성이 변경되면 `system_server`에서 동작하는 `ActivityManagerService`에서 앱 프로세스의 메인 클래스인 `ActivityThread`에 새로운 `Configuration`을 전달함.
* 결과적으로 하는 일은 `AssetManager`의 네이티브 메소드인 `setConfiguration`을 실행하는 것
* 네이티브에서는 리소스 테이블을 유지하고 잇는데, 현재 Configuration을 전달해놓고 리소스를 가져올 때마다 현재 Configuration에 맞는 리소스를 선택해서 가져옴.